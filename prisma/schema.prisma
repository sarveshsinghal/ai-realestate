generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ListingCondition {
  NEW
  RENOVATED
  GOOD
  TO_RENOVATE
}

enum EnergyClass {
  A
  B
  C
  D
  E
  F
}

enum MemberRole {
  ADMIN
  MANAGER
  AGENT
  VIEWER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  VIEWING
  OFFER
  WON
  LOST
}

model User {
  id             String   @id @default(cuid())
  // Link this to Supabase auth.users.id (uuid)
  supabaseUserId String   @unique

  email          String?
  name           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  memberships    AgencyMember[]
}

model Agency {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   AgencyMember[]
  listings  Listing[]
  leads     Lead[]
}

model AgencyMember {
  id             String     @id @default(cuid())
  agencyId        String
  userId          String

  // Supabase auth user id (uuid) for scoping without joining User table
  supabaseUserId  String
  email           String
  role            MemberRole @default(AGENT)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  agency          Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  user            User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([agencyId, userId])
  @@unique([agencyId, supabaseUserId])
  @@index([userId])
  @@index([agencyId])
  @@index([supabaseUserId])
}


model Listing {
  id          String   @id @default(cuid())

  // Public-facing fields
  title       String
  commune     String
  addressHint String?
  price       Int      // EUR
  sizeSqm     Int
  bedrooms    Int
  bathrooms   Int
  condition   ListingCondition
  energyClass EnergyClass

  // Make nullable to allow seed/backfill before agency linkage (recommended)
  agencyId    String?
  agency      Agency?  @relation(fields: [agencyId], references: [id], onDelete: SetNull)

  // Optional denormalized name (useful for seed/import + auto-link)
  agencyName  String?

  isPublished Boolean @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  media        ListingMedia[]
  priceHistory ListingPriceHistory[]
  leads        Lead[]

  @@index([commune])
  @@index([price])
  @@index([bedrooms])
  @@index([agencyId])
}

model ListingMedia {
  id        String @id @default(cuid())
  listingId String
  url       String
  sortOrder Int    @default(0)

  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
}

model ListingPriceHistory {
  id         String   @id @default(cuid())
  listingId  String
  price      Int
  recordedAt DateTime @default(now())

  listing    Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId, recordedAt])
}

model Lead {
  id        String   @id @default(cuid())

  // Make nullable to allow older leads / transitional data
  agencyId  String?
  listingId String?

  name      String
  email     String
  phone     String?
  message   String?

  status    LeadStatus @default(NEW)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agency    Agency?  @relation(fields: [agencyId], references: [id], onDelete: SetNull)
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  @@index([agencyId, createdAt])
  @@index([listingId])
  @@index([status])
}
